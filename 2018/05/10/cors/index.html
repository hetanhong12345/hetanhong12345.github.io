<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>cors | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前后端分离 前端和后端代码分别部署在不同的服务器。 后端只需向前端提供json接口，接口只需返回请求正确或者失败原因。 前端在开发过程中不必等待后端提供接口，可先自行约定接口数据模型。 哪些网站适合前后端分离： 网站前端变化远比端变化频繁 网站前端团队和后端团队技能点差异大 网站前端效果绚丽/跨设备兼容要求高   前后端分离主要有如下技术难点 跨域请求 身份认证    浏览器的同源策略 如果协议，">
<meta name="keywords" content="cors 跨域解决方案">
<meta property="og:type" content="article">
<meta property="og:title" content="cors">
<meta property="og:url" content="http://yoursite.com/2018/05/10/cors/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="前后端分离 前端和后端代码分别部署在不同的服务器。 后端只需向前端提供json接口，接口只需返回请求正确或者失败原因。 前端在开发过程中不必等待后端提供接口，可先自行约定接口数据模型。 哪些网站适合前后端分离： 网站前端变化远比端变化频繁 网站前端团队和后端团队技能点差异大 网站前端效果绚丽/跨设备兼容要求高   前后端分离主要有如下技术难点 跨域请求 身份认证    浏览器的同源策略 如果协议，">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-05-10T14:52:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cors">
<meta name="twitter:description" content="前后端分离 前端和后端代码分别部署在不同的服务器。 后端只需向前端提供json接口，接口只需返回请求正确或者失败原因。 前端在开发过程中不必等待后端提供接口，可先自行约定接口数据模型。 哪些网站适合前后端分离： 网站前端变化远比端变化频繁 网站前端团队和后端团队技能点差异大 网站前端效果绚丽/跨设备兼容要求高   前后端分离主要有如下技术难点 跨域请求 身份认证    浏览器的同源策略 如果协议，">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="photo-cors" class="article article-type-photo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/10/cors/" class="article-date">
  <time datetime="2018-05-10T14:50:43.000Z" itemprop="datePublished">2018-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      cors
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h1><ul>
<li>前端和后端代码分别部署在不同的服务器。</li>
<li>后端只需向前端提供json接口，接口只需返回请求正确或者失败原因。</li>
<li>前端在开发过程中不必等待后端提供接口，可先自行约定接口数据模型。</li>
<li>哪些网站适合前后端分离：<ul>
<li>网站前端变化远比端变化频繁</li>
<li>网站前端团队和后端团队技能点差异大</li>
<li>网站前端效果绚丽/跨设备兼容要求高</li>
</ul>
</li>
<li>前后端分离主要有如下技术难点<ul>
<li>跨域请求</li>
<li>身份认证</li>
</ul>
</li>
</ul>
<h2 id="浏览器的同源策略"><a href="#浏览器的同源策略" class="headerlink" title="浏览器的同源策略"></a>浏览器的同源策略</h2><ul>
<li>如果协议，端口和域名对于两个页面是相同的，则两个页面具有相同的源</li>
<li>同源策略限制从一个源加载的文档或脚本如何与来自另一个源的资源进行交互。<br>这是一个用于隔离潜在恶意文件的关键的安全机制。</li>
</ul>
<h2 id="跨域-HTTP-请求"><a href="#跨域-HTTP-请求" class="headerlink" title="跨域 HTTP 请求"></a>跨域 HTTP 请求</h2><ul>
<li>当一个资源从与该资源本身所在的服务器不同的源请求一个资源时，<br>资源会发起一个跨域 HTTP 请求。</li>
<li>出于安全考虑，浏览器会限制从脚本内发起的跨域HTTP请求。</li>
<li>也可能是跨站请求可以正常发起，但是返回结果被浏览器拦截了。<ul>
<li>XMLHttpRequest 或 Fetch 发起的跨域 HTTP 请求。</li>
<li>Web 字体 (CSS 中通过 @font-face 使用跨域字体资源)。</li>
<li>使用 drawImage 将 Images/video 画面绘制到 canvas。</li>
<li>Scripts (未处理的异常)。</li>
<li>其他。。。<h2 id="跨域资源共享（-CORS-）"><a href="#跨域资源共享（-CORS-）" class="headerlink" title="跨域资源共享（ CORS ）"></a>跨域资源共享（ CORS ）</h2><ul>
<li>跨域资源共享（ CORS ）机制允许 Web 应用服务器进行跨域访问控制，从而使跨域数据传输得以安全进行。</li>
<li>浏览器支持在 API 容器中（例如 XMLHttpRequest 或 Fetch ）使用 CORS，以降低跨域 HTTP 请求所带来的风险。</li>
<li>CORS 需要客户端和服务器同时支持。目前，所有浏览器都支持该机制（IE 10 提供了对规范的完整支持，但在较早版本中，<br>CORS 机制是借由 XDomainRequest 对象完成）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client</span></span><br><span class="line"><span class="comment">// origin ：https://zj-static.zj-hf.cn</span></span><br><span class="line">     <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">     <span class="keyword">var</span> url = <span class="string">'https://zj-weixin.zj-hf.cn/personalCenter'</span>;</span><br><span class="line">     request.open(<span class="string">'GET'</span>, url, <span class="literal">true</span>);</span><br><span class="line">     request.onreadystatechange = handler;</span><br><span class="line">     request.send();</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server </span></span><br><span class="line">      res.header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">'*'</span>);  <span class="comment">// 允许所有域名访问</span></span><br><span class="line">      res.header(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="literal">false</span>); <span class="comment">// 不携带身份信息</span></span><br></pre></td></tr></table></figure>
<h2 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h2><ul>
<li>“需预检的请求”要求必须先使用 OPTIONS方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。</li>
<li>“预检请求“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。</li>
<li>下列情况下需先发送预检请求。<ul>
<li>使用了下面任一 HTTP 方法：PUT，DELETE，CONNECT，OPTIONS，TRACE，PATCH。</li>
<li>人为设置了对 CORS 安全的首部字段集合之外的其他首部字段。该集合为：Accept，Accept-Language，Content-Language，Content-Type，DPR，Downlink，Save-Data，Viewport-Width，Width。</li>
<li>Content-Type 的值不属于下列之一:application/x-www-form-urlencoded，multipart/form-data，text/plain</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// client</span></span><br><span class="line"><span class="comment">// origin ：https://zj-static.zj-hf.cn</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'https://zj-weixin.zj-hf.cn/personalCenter'</span>;</span><br><span class="line">  <span class="keyword">var</span> body = <span class="string">'&lt;?xml version="1.0"?&gt;&lt;person&gt;&lt;name&gt;Arun&lt;/name&gt;&lt;/person&gt;'</span>;</span><br><span class="line">   request.open(<span class="string">'POST'</span>, url, <span class="literal">true</span>);</span><br><span class="line">   request.setRequestHeader(<span class="string">'X-PINGOTHER'</span>, <span class="string">'pingpong'</span>);<span class="comment">// 集合之外的header</span></span><br><span class="line">   request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/xml'</span>); <span class="comment">// 不是三种之一</span></span><br><span class="line">   request.send(body);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server </span></span><br><span class="line"><span class="comment">// add cors middleware</span></span><br><span class="line">    app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> origin = ctx.get(<span class="string">'Origin'</span>);</span><br><span class="line">        ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, origin);</span><br><span class="line">        ctx.set(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="literal">false</span>);</span><br><span class="line">        ctx.set(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'PUT, GET, POST, DELETE, OPTIONS'</span>);</span><br><span class="line">        ctx.set(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'X-PINGOTHER, Content-Type'</span>);</span><br><span class="line">        ctx.set(<span class="string">'Access-Control-Max-Age'</span>, <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>); <span class="comment">// 设置预检请求缓存时间</span></span><br><span class="line">        <span class="keyword">let</span> method = ctx.method;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'OPTIONS'</span> === method) &#123;</span><br><span class="line">             ctx.status = <span class="number">204</span>;<span class="comment">// 不返回任何实体</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">await</span>  next();</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><ul>
<li>某些请求不会触发 CORS 预检请求，称为简单请求。</li>
<li>简单请求必须满足下列条件。<ul>
<li>使用下列方法之一： GET，HEAD，POST</li>
<li>不得人为设置该集合之外的其他首部字段。该集合为：<br>Accept，Accept-Language，Content-Language，Content-Type，DPR，Downlink，Save-Data，Viewport-Width，Width。</li>
<li>Content-Type 的值仅限于下列三者之一：<br>application/x-www-form-urlencoded，multipart/form-data，text/plain。<ul>
<li>简单请求将直接发送实际请求。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="附带身份凭证的请求–cookie"><a href="#附带身份凭证的请求–cookie" class="headerlink" title="附带身份凭证的请求–cookie"></a>附带身份凭证的请求–cookie</h2><ul>
<li>CORS 的一个特性是，可以基于  HTTP cookies 和 HTTP 认证信息发送身份凭证。对于跨域 XMLHttpRequest 或 Fetch 请求，浏览器默认不会<br>发送身份凭证信息。如果要发送凭证信息，需要设置 XMLHttpRequest 的某个特殊标志位–withCredentials。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client</span></span><br><span class="line"><span class="comment">// origin ：https://zj-static.zj-hf.cn</span></span><br><span class="line"><span class="comment">//  user login</span></span><br><span class="line">   <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">   <span class="keyword">var</span> url = <span class="string">'https://zj-weixin.zj-hf.cn/login'</span>;</span><br><span class="line">   <span class="keyword">var</span> body = <span class="string">'mobile=13720057698&amp;password=hxx123456'</span>; <span class="comment">// application/x-www-form-urlencoded </span></span><br><span class="line">   request.open(<span class="string">'POST'</span>, url, <span class="literal">true</span>);</span><br><span class="line">   request.withCredentials = <span class="literal">true</span>; <span class="comment">// 携带身份信息</span></span><br><span class="line">   request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/x-www-form-urlencoded'</span>); <span class="comment">// </span></span><br><span class="line">   request.send(body);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server </span></span><br><span class="line">user.login = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;body&#125; = ctx.request;</span><br><span class="line">    <span class="keyword">let</span> &#123;mobile, password&#125; = body;</span><br><span class="line">    <span class="keyword">let</span> userInfo = <span class="keyword">await</span>  <span class="keyword">new</span> User(&#123;mobile, password&#125;).fetch();</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'https://zj-static.zj-hf.cn'</span>);</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="literal">true</span>);<span class="comment">// 允许在response 里写入 cookie</span></span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'PUT, GET, POST, DELETE, OPTIONS'</span>);</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-Type'</span>);</span><br><span class="line">     ctx.cookies.set(</span><br><span class="line">          <span class="string">'cid'</span>, </span><br><span class="line">         userInfo,</span><br><span class="line">          &#123;</span><br><span class="line">            domain: <span class="string">'zj-hf.cn'</span>,  <span class="comment">// 指定了需要发送Cookie的域名</span></span><br><span class="line">            path: <span class="string">'/'</span>,       <span class="comment">// 指定了需要发送Cooki的路径</span></span><br><span class="line">            maxAge:<span class="number">60</span>*<span class="number">60</span>,   <span class="comment">// 有效时长 </span></span><br><span class="line">            expires: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2018-02-15'</span>),  <span class="comment">// cookie失效时间</span></span><br><span class="line">            httpOnly: <span class="literal">false</span>,  <span class="comment">// 是否只用于http请求中获取</span></span><br><span class="line">            overwrite: <span class="literal">false</span>  <span class="comment">// 是否允许重写</span></span><br><span class="line">          &#125;)</span><br><span class="line">    <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client</span></span><br><span class="line"><span class="comment">// origin ：https://zj-static.zj-hf.cn</span></span><br><span class="line"><span class="comment">//  get userInfo </span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">   <span class="keyword">var</span> url = <span class="string">'https://zj-weixin.zj-hf.cn/getUserInfo'</span>;</span><br><span class="line">   request.open(<span class="string">'GET'</span>, url, <span class="literal">true</span>);</span><br><span class="line">   request.withCredentials = <span class="literal">true</span>; <span class="comment">// 携带身份信息</span></span><br><span class="line">   request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/x-www-form-urlencoded'</span>); <span class="comment">// </span></span><br><span class="line">   request.send();</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server </span></span><br><span class="line">user.getInfo = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'https://zj-static.zj-hf.cn'</span>);</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="literal">true</span>);<span class="comment">// 允许在response 里写入 cookie</span></span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'PUT, GET, POST, DELETE, OPTIONS'</span>);</span><br><span class="line">     ctx.set(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-Type'</span>);</span><br><span class="line">     <span class="keyword">let</span> userInfo = ctx.cookies.get(<span class="string">'cid'</span>); <span class="comment">// 从cookie里读取用户信息</span></span><br><span class="line">    <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="cookie-作为身份凭证："><a href="#cookie-作为身份凭证：" class="headerlink" title="cookie 作为身份凭证："></a>cookie 作为身份凭证：</h3><ul>
<li><p>cookie认证流程 </p>
<ul>
<li>客户端根据用户名、密码或者验证码登录</li>
<li>服务端验证正确之后将cookie设置到response里，同时将用户信息或者用户id储存到session中。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cookies.set(<span class="string">'cid'</span>,encrypt);</span><br><span class="line">session.set(encrypt,userInfo)</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端发出携带cookie的请求</li>
<li><p>服务端从cookie里取出cid，进行校验</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cid = ctx.cookies.get(<span class="string">'cid'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> userInfo = session.get(cid)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>- 校验成功后，返回相应数据
</code></pre><ul>
<li><p>使用cookie作为认证凭证有一些不方便，比如不能跨平台，当有多个客户端平台调用同一个服务端时，<br>需要根据不同的平台设置不同的返回头部。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'https://zj-static.zj-hf.cn'</span>);</span><br><span class="line">ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'https://zj-static.zj-wm.cn'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>当服务端把用户信息清空之后（比如服务重启，清空redis等操作），用户登录状态消失。</li>
<li>使用不当存在安全隐患(<a href="https://baike.baidu.com/item/XSS%E6%94%BB%E5%87%BB/954065?fr=aladdin" target="_blank" rel="noopener">XSS攻击</a>和<a href="https://en.wikipedia.org/wiki/HTTP_cookie#Cross-site_request_forgery" target="_blank" rel="noopener">CSRF攻击</a>)</li>
</ul>
<h2 id="附带身份凭证的请求–token"><a href="#附带身份凭证的请求–token" class="headerlink" title="附带身份凭证的请求–token"></a>附带身份凭证的请求–token</h2><ul>
<li>使用token验证方式，可以允许任何其他域名的请求访问。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'*'</span>);<span class="comment">// 允许所有域名访问</span></span><br></pre></td></tr></table></figure>
<ul>
<li>客户端使用用户名跟密码请求登录</li>
<li>服务端收到请求，去验证用户名与密码</li>
<li>验证成功后，服务端会签发一个 Token，再把这个 Token 发送给客户端</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx.body = &#123;</span><br><span class="line">            code: <span class="number">200</span>,</span><br><span class="line">            data:&#123;token,userInfo&#125;,</span><br><span class="line">            msg: <span class="string">'ok'</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端收到 Token 以后可以把它存储起来，比如放在 Cookie 里或者 Local Storage 里</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localStorage.setItem(<span class="string">'auth_token'</span>,data.token);</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端每次向服务端请求资源的时候需要带着服务端签发的 Token</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/x-www-form-urlencoded'</span>); <span class="comment">// </span></span><br><span class="line">request.setRequestHeader(<span class="string">'X-Token'</span>, localStorage.getItem(<span class="string">'auth_token'</span>)); <span class="comment">//</span></span><br></pre></td></tr></table></figure>
<ul>
<li>服务端收到请求，验证Token，如果成功，就向客户端返回请求的数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-Type,X-Token'</span>);</span><br><span class="line"><span class="keyword">let</span>  token = ctx.get(<span class="string">'X-Token'</span>);</span><br><span class="line">verify(token);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/10/cors/" data-id="cjh0njlha0000et54ewhuvs6g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cors-跨域解决方案/">cors 跨域解决方案</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/05/10/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/cors-跨域解决方案/">cors 跨域解决方案</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/cors-跨域解决方案/" style="font-size: 10px;">cors 跨域解决方案</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/10/cors/">cors</a>
          </li>
        
          <li>
            <a href="/2018/05/10/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>